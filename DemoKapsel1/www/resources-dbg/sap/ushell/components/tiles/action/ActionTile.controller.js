// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";sap.ui.getCore().loadLibrary("sap.m");jQuery.sap.require("sap.ui.core.IconPool");jQuery.sap.require("sap.ushell.components.tiles.utils");sap.ui.controller("sap.ushell.components.tiles.action.ActionTile",{onInit:function(){var v=this.getView(),V=v.getViewData(),r=sap.ushell.components.tiles.utils.getResourceBundleModel(),t=V.chip,c=t.configuration.getParameterValueAsString('tileConfiguration'),C=sap.ushell.components.tiles.utils.getActionConfiguration(c,t.configurationUi.isEnabled()),m,a=this;function f(s,S){var b=r.getResourceBundle(),R=b.getText("configuration.semantic_object")+":\n"+s+"\n\n"+b.getText("configuration.semantic_action")+":\n"+S;return R;}v.setModel(r,"i18n");m=new sap.ui.model.json.JSONModel({config:C,displayText:f(C.semantic_object,C.semantic_action)});v.setModel(m);if(t.configurationUi.isEnabled()){t.configurationUi.setUiProvider(function(){var o=sap.ushell.components.tiles.utils.getConfigurationUi(a.getView(),"sap.ushell.components.tiles.action.Configuration");t.configurationUi.attachCancel(this.onCancelConfiguration.bind(null,o));t.configurationUi.attachSave(this.onSaveConfiguration.bind(this,o,f));return o;}.bind(this));v.byId("actionTile").setTooltip(r.getResourceBundle().getText("edit_configuration.tooltip"));}},onPress:function(e){var t=this.getView().getViewData().chip;if(t.configurationUi.isEnabled()){t.configurationUi.display();}},onSaveConfiguration:function(c,f){var d=jQuery.Deferred(),m=c.getModel(),t=m.getProperty("/tileModel"),T=c.getViewData().chip;function l(E){jQuery.sap.log.warning(E,null,"sap.ushell.components.tiles.action.ActionTile.controller");d.reject(E);}var r=sap.ushell.components.tiles.utils.checkTMInputOnSaveConfig(c);if(r){d.reject("mandatory_fields_missing");return d.promise();}if(sap.ushell.components.tiles.utils.tableHasDuplicateParameterNames(m.getProperty("/config/rows"))){var b=sap.ushell.components.tiles.utils.getResourceBundleModel().getResourceBundle();d.reject(b.getText("configuration.signature.uniqueParamMessage.text"));}else{var F=m.getProperty("/config/formFactorConfigDefault")?undefined:sap.ushell.components.tiles.utils.buildFormFactorsObject(m);var M=sap.ushell.components.tiles.utils.getMappingSignatureString(m.getProperty("/config/rows"),m.getProperty("/config/isUnknownAllowed"));var a={semantic_object:jQuery.trim(m.getProperty("/config/semantic_object"))||"",semantic_action:jQuery.trim(m.getProperty("/config/semantic_action"))||"",display_title_text:jQuery.trim(m.getProperty("/config/display_title_text"))||"",url:jQuery.trim(m.getProperty("/config/url"))||"",ui5_component:jQuery.trim(m.getProperty("/config/ui5_component"))||"",navigation_provider:jQuery.trim(m.getProperty("/config/navigation_provider")),navigation_provider_role:jQuery.trim(m.getProperty("/config/navigation_provider_role"))||"",navigation_provider_instance:jQuery.trim(m.getProperty("/config/navigation_provider_instance"))||"",target_application_id:jQuery.trim(m.getProperty("/config/target_application_id"))||"",target_application_alias:jQuery.trim(m.getProperty("/config/target_application_alias"))||"",display_info_text:jQuery.trim(m.getProperty("/config/display_info_text")),form_factors:F,mapping_signature:M};var e=T.bag.getBag('tileProperties');e.setText('display_title_text',a.display_title_text);T.writeConfiguration.setParameterValues({tileConfiguration:JSON.stringify(a)},function(){var C=T.configuration.getParameterValueAsString('tileConfiguration'),o=sap.ushell.components.tiles.utils.getActionConfiguration(C,false),g=sap.ushell.components.tiles.utils.getActionConfiguration(C,true);m=new sap.ui.model.json.JSONModel({config:o,tileModel:t});c.setModel(m);t.setData({config:g,displayText:f(g.semantic_object,g.semantic_action)},false);e.save(function(){jQuery.sap.log.debug("property bag 'tileProperties' saved successfully");if(T.title){T.title.setTitle(a.display_title_text,function(){d.resolve();},l);}else{d.resolve();}},l);},l);}return d.promise();},onCancelConfiguration:function(c){var v=c.getViewData(),m=c.getModel(),t=m.getProperty("/tileModel"),T=v.chip,C=sap.ushell.components.tiles.utils.getActionConfiguration(T.configuration.getParameterValueAsString('tileConfiguration'),false);c.getModel().setData({config:C,tileModel:t},false);}});}());
