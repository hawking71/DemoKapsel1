// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";var p="sap.ushell.components.container.",c=p+"ApplicationContainer",d="sap.ushell.Container.dirtyState.",l,r;jQuery.sap.declare("sap.ushell.components.container.ApplicationContainer");jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ushell.library");jQuery.sap.require("sap.ui.core.UIComponent");l=new sap.ushell.utils.Map();sap.ushell.components.container.ApplicationType={URL:"URL",WDA:"WDA",NWBC:"NWBC"};sap.ushell.utils.testPublishAt(sap.ushell.components.container);function g(C){return l.get(C.getId());}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function a(U){var P=jQuery.sap.getUriParameters(U).mParams,x=P["sap-xapp-state"];delete P["sap-xapp-state"];return{startupParameters:P,"sap-xapp-state":x};}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function b(K,A){if(!r){r=jQuery.sap.resources({url:jQuery.sap.getModulePath(p)+"/resources/resources.properties",language:sap.ui.getCore().getConfiguration().getLanguage()});}return r.getText(K,A);}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function f(){return new sap.ui.core.Icon({size:"2rem",src:"sap-icon://error",tooltip:b("an_error_has_occured")});}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function h(C){var e=C.getAggregation("child"),x;if(e instanceof sap.ui.core.ComponentContainer){x=e.getComponentInstance().getMetadata().getName().replace(/\.Component$/,"");jQuery.sap.log.debug("unloading component "+x,null,c);}C.destroyAggregation("child");}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function i(C,U,A){var e,x,I,L,M,y,N,V,z,B;I=U.indexOf("?");if(I>=0){y=a(U);V=y.startupParameters;U=U.slice(0,I);}if(U.slice(-1)!=='/'){U+='/';}if(/\.view\.(\w+)$/i.test(A)){M=/^SAPUI5=(?:([^\/]+)\/)?([^\/]+)\.view\.(\w+)$/i.exec(A);if(!M){jQuery.sap.log.error("Invalid SAPUI5 URL",A,c);return f();}N=M[1];z=M[2];B=M[3].toUpperCase();if(N){z=N+"."+z;}else{L=z.lastIndexOf(".");if(L<1){jQuery.sap.log.error("Missing namespace",A,c);return f();}N=z.slice(0,L);}}else{N=A.replace(/^SAPUI5=/,"");}jQuery.sap.registerModulePath(N,U+N.replace(/\./g,'/'));h(C);if(z){x=sap.ui.view({id:C.getId()+"-content",type:B,viewData:V||{},viewName:z});C.fireEvent("applicationConfiguration");}else{jQuery.sap.log.debug("loading component "+N,null,c);e=sap.ui.component({id:C.getId()+"-component",componentData:y?{startupParameters:y.startupParameters,"sap-xapp-state":y["sap-xapp-state"]}:{},name:N});C.fireEvent("applicationConfiguration",{"configuration":e.getMetadata().getConfig()});x=new sap.ui.core.ComponentContainer({id:C.getId()+"-content",component:e});}x.setWidth(C.getWidth());x.setHeight(C.getHeight());x.addStyleClass("sapUShellApplicationContainer");C.setAggregation("child",x,true);return x;}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function j(C,U,e){var I,x,y,z,A={};I=U.indexOf("?");if(I>=0){z=a(U);A={startupParameters:z.startupParameters,"sap-xapp-state":z["sap-xapp-state"]};U=U.slice(0,I);}if(U.slice(-1)!=='/'){U+='/';}jQuery.sap.registerModulePath(e,U);jQuery.sap.require("sap.ushell.services.CrossApplicationNavigation");h(C);jQuery.sap.log.debug("loading component "+e,null,c);x=sap.ui.component({id:C.getId()+"-component",name:e,componentData:A});C.fireEvent("applicationConfiguration",{"configuration":x.getMetadata().getConfig()});y=new sap.ui.core.ComponentContainer({id:C.getId()+"-content",component:x});y.setHeight(C.getHeight());y.setWidth(C.getWidth());y.addStyleClass("sapUShellApplicationContainer");C.setAggregation("child",y,true);return y;}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function k(U){var A=document.createElement("a"),C=jQuery.sap.getUriParameters(U).get("sap-client"),B;A.href=U;B=A.protocol+"//"+A.host;return new sap.ushell.System({alias:C?B+"?sap-client="+C:B,baseUrl:B,client:C||undefined,platform:"abap"});}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function m(C,M){var T=false,D=C.getDomRef(),A=C.getApplicationType(),U,O;if(D){if(A===sap.ushell.components.container.ApplicationType.NWBC){U=URI(D.src);O=U.protocol()+"://"+U.host();T=(M.source===D.contentWindow)||(M.origin===O);}else if(A===sap.ushell.components.container.ApplicationType.URL){U=URI();O=U.protocol()+"://"+U.host();T=(M.origin===O);}}return T;}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function n(C,M,e){var P=jQuery.sap.getObject("sap-ushell-config.services.PostMessage.config",0),S=e&&e.service;if(!S||S.indexOf("sap.ushell.services.CrossApplicationNavigation")!==0||e.type!=="request"){return;}if(P&&P.enabled===false){jQuery.sap.log.warning("Received message for CrossApplicationNavigation, but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return;}if(!m(C,M)){jQuery.sap.log.warning("Received message from untrusted origin: "+M.origin,M.data,"sap.ushell.components.container.ApplicationContainer");return;}function x(z,B){M.source.postMessage(JSON.stringify({type:"response",service:e.service,request_id:e.request_id,status:z,body:B}),M.origin);}function y(z){switch(z){case"sap.ushell.services.CrossApplicationNavigation.hrefForExternal":return jQuery.Deferred().resolve(sap.ushell.Container.getService("CrossApplicationNavigation").hrefForExternal(e.body.oArgs)).promise();case"sap.ushell.services.CrossApplicationNavigation.getSemanticObjectLinks":return sap.ushell.Container.getService("CrossApplicationNavigation").getSemanticObjectLinks(e.body.sSemanticObject,e.body.mParameters,e.body.bIgnoreFormFactors);case"sap.ushell.services.CrossApplicationNavigation.isIntentSupported":return sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported(e.body.aIntents);case"sap.ushell.services.CrossApplicationNavigation.toExternal":return jQuery.Deferred().resolve(sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(e.body.oArgs)).promise();}}try{y(e.service).done(function(R){x("success",{result:R});}).fail(function(z){x("error",{message:z});});}catch(E){x("error",{message:E.message});}}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function o(C,M){var x=M.data;if(typeof x==="string"){try{x=JSON.parse(M.data);}catch(e){jQuery.sap.log.debug("Message received from origin '"+M.origin+"' cannot be parsed: "+e,x,"sap.ushell.components.container.ApplicationContainer");return;}}if(x.action==="pro54_setGlobalDirty"&&localStorage.getItem(C.globalDirtyStorageKey)===sap.ushell.Container.DirtyState.PENDING){if(!m(C,M)){jQuery.sap.log.warning("Received message from untrusted origin: "+M.origin,x,"sap.ushell.components.container.ApplicationContainer");return;}jQuery.sap.log.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+C.globalDirtyStorageKey+" value: "+x.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");sap.ushell.utils.localStorageSetItem(C.globalDirtyStorageKey,x.parameters.globalDirty,true);}else{n(C,M,x);}}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function q(C,e){var I=C.getDomRef();if(C.getApplicationType()===sap.ushell.components.container.ApplicationType.NWBC&&I&&I.tagName==="IFRAME"){I.contentWindow.postMessage(JSON.stringify({action:"pro54_disableDirtyHandler"}),'*');e.preventDefault();}}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function s(R,C,e){R.write("<div").writeControlData(C).writeAccessibilityState(C).addClass("sapUShellApplicationContainer").writeClasses(C).addStyle("height",C.getHeight()).addStyle("width",C.getWidth()).writeStyles().write(">").renderControl(e);R.write("</div>");}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function t(U){var T,e=function(){return jQuery.sap.getUriParameters().get("sap-theme")||sap.ushell.Container.getUser().getTheme()||sap.ui.getCore().getConfiguration().getTheme();},x=function(){var y=sap.ushell.utils.getParameterValueBoolean("sap-accessibility");if(y!==undefined){return y;}return sap.ushell.Container.getUser().getAccessibilityMode();};U+=U.indexOf("?")>=0?"&":"?";U+="sap-ie=edge";T=e();if(T){U+=U.indexOf("?")>=0?"&":"?";U+="sap-theme="+encodeURIComponent(T);}if(x()){U+=U.indexOf("?")>=0?"&":"?";U+="sap-accessibility=X";}return U;}function u(R,C,U,e){var x=C.getAggregation("child");if(!x||C._bRecreateChild){x=j(C,U,e);C._bRecreateChild=false;}s(R,C,x);}function v(C,K,V){var O=C.getProperty(K);if(jQuery.sap.equal(O,V)){return;}C.setProperty(K,V);C._bRecreateChild=true;}sap.ushell.utils.testPublishAt(sap.ushell.components.container);function w(R,C,A,U,e){var L,x;localStorage.removeItem(C.globalDirtyStorageKey);if(e&&e.indexOf("SAPUI5.Component=")===0&&A===sap.ushell.components.container.ApplicationType.URL){u(R,C,U,e.replace(/^SAPUI5\.Component=/,""));return;}if(e&&e.indexOf("SAPUI5=")===0&&A===sap.ushell.components.container.ApplicationType.URL){s(R,C,i(C,U,e));return;}jQuery.sap.log.debug("Not resolved as \"SAPUI5.Component=\" or \"SAPUI5=\" , "+"will attempt to load into iframe "+e);try{U=C.getFrameSource(A,U,e);}catch(y){jQuery.sap.log.error(y.message||y,null,c);C.fireEvent("applicationConfiguration");R.renderControl(f());return;}if(sap.ushell.Container){L=g(C);if(!L){if(A===sap.ushell.components.container.ApplicationType.NWBC){L=q.bind(null,C);l.put(C.getId(),L);sap.ushell.Container.attachLogoutEvent(L);sap.ushell.Container.addRemoteSystem(k(U));}}else{if(A!==sap.ushell.components.container.ApplicationType.NWBC){sap.ushell.Container.detachLogoutEvent(L);l.remove(C.getId());}}}if(A===sap.ushell.components.container.ApplicationType.NWBC){U=t(U);sap.ushell.utils.localStorageSetItem(C.globalDirtyStorageKey,sap.ushell.Container.DirtyState.INITIAL);}C.fireEvent("applicationConfiguration");R.write("<iframe").writeControlData(C).writeAccessibilityState(C).writeAttributeEscaped("src",U).addClass("sapUShellApplicationContainer").writeClasses(C).addStyle("height",C.getHeight()).addStyle("width",C.getWidth()).writeStyles().write("></iframe>");}sap.ui.core.Control.extend(c,{metadata:{properties:{additionalInformation:{defaultValue:"",type:"string"},application:{type:"object"},applicationType:{defaultValue:"URL",type:p+"ApplicationType"},height:{defaultValue:"100%",type:"sap.ui.core.CSSSize"},url:{defaultValue:"",type:"string"},visible:{defaultValue:true,type:"boolean"},width:{defaultValue:"100%",type:"sap.ui.core.CSSSize"}},events:{"applicationConfiguration":{}},aggregations:{child:{multiple:false,type:"sap.ui.core.Control",visibility:"hidden"}},library:"sap.ushell"},exit:function(){var L;if(sap.ushell.Container){L=g(this);if(L){sap.ushell.Container.detachLogoutEvent(L);l.remove(this.getId());}}localStorage.removeItem(this.globalDirtyStorageKey);if(this._unloadEventListener){removeEventListener("unload",this._unloadEventListener);}if(this._storageEventListener){removeEventListener("storage",this._storageEventListener);}if(this._messageEventListener){removeEventListener("message",this._messageEventListener);}h(this);if(sap.ui.core.Control.exit){sap.ui.core.Control.exit.apply(this);}},init:function(){var e=this;this.globalDirtyStorageKey=d+jQuery.sap.uid();this._unloadEventListener=this.exit.bind(this);addEventListener("unload",this._unloadEventListener);this._storageEventListener=function(S){if(S.key===e.globalDirtyStorageKey&&S.newValue===sap.ushell.Container.DirtyState.PENDING&&e.getApplicationType()===sap.ushell.components.container.ApplicationType.NWBC){var I=e.getDomRef();if(I&&I.tagName==="IFRAME"){jQuery.sap.log.debug("getGlobalDirty() send pro54_getGlobalDirty ",null,"sap.ushell.components.container.ApplicationContainer");I.contentWindow.postMessage(JSON.stringify({action:"pro54_getGlobalDirty"}),'*');}}};addEventListener('storage',this._storageEventListener);this._messageEventListener=o.bind(null,this);addEventListener('message',this._messageEventListener);},renderer:function(R,C){var A=C.getApplication(),L=C.launchpadData,e;if(!C.getVisible()){s(R,C);return;}if(C.error){delete C.error;s(R,C,f());}else if(!A){w(R,C,C.getApplicationType(),C.getUrl(),C.getAdditionalInformation());}else if(!A.isResolvable()){w(R,C,A.getType(),A.getUrl(),"");}else if(L){w(R,C,L.applicationType,L.Absolute.url.replace(/\?$/,""),L.applicationData);}else{jQuery.sap.log.debug("Resolving "+A.getUrl(),null,c);A.resolve(function(x){jQuery.sap.log.debug("Resolved "+A.getUrl(),JSON.stringify(x),c);C.launchpadData=x;h(C);},function(E){var x=A.getMenu().getDefaultErrorHandler();if(x){x(E);}h(C);C.error=E;});e=new sap.m.Text({text:b("loading",[A.getText()])});h(C);C.setAggregation("child",e);s(R,C,e);}}});sap.ushell.components.container.ApplicationContainer.prototype.getFrameSource=function(A,U,e){if(!Object.prototype.hasOwnProperty.call(sap.ushell.components.container.ApplicationType,A)){throw new Error("Illegal application type: "+A);}return U;};sap.ushell.components.container.ApplicationContainer.prototype.setUrl=function(V){v(this,"url",V);};sap.ushell.components.container.ApplicationContainer.prototype.setAdditionalInformation=function(V){v(this,"additionalInformation",V);};sap.ushell.components.container.ApplicationContainer.prototype.setApplicationType=function(V){v(this,"applicationType",V);};}());
