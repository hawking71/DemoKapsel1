jQuery.sap.require("sap.ushell.components.tiles.generic");(function(){"use strict";sap.ushell.components.tiles.generic.extend("tiles.indicatorcontribution.ContributionTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false;},doProcess:function(){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);this.setTextInTile();this.fetchChartData(function(k){this.CALCULATED_KPI_VALUE=k;this._updateTileModel({data:this.CALCULATED_KPI_VALUE});if(t.oConfig.TILE_PROPERTIES.frameType==sap.suite.ui.commons.FrameType.TwoByOne){t.oKpiTileView.oGenericTile.setFrameType(sap.suite.ui.commons.FrameType.TwoByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.getView().getViewData().parentController._updateTileModel(this.getTile().getModel().getData());t.getView().getViewData().deferredObj.resolve();}else{t.oKpiTileView.oGenericTile.setFrameType(sap.suite.ui.commons.FrameType.OneByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.oKpiTileView.oGenericTile.addTileContent(t.oKpiTileView.oComparisonTile);var n=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);t.oKpiTileView.oGenericTile.$().wrap("<a href ='"+n+"'/>");this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded);}this.setToolTip(null,this.CALCULATED_KPI_VALUE,"CONT");},this.logError);},fetchChartData:function(s,E){var t=this;try{var u=this.oConfig.EVALUATION.ODATA_URL;var a=this.oConfig.EVALUATION.ODATA_ENTITYSET;var T=t.setThresholdValues();if(this.oConfig.TILE_PROPERTIES.semanticMeasure){var m=this.oConfig.EVALUATION.COLUMN_NAME+","+this.oConfig.TILE_PROPERTIES.semanticMeasure;}else{var m=this.oConfig.EVALUATION.COLUMN_NAME;}var b=null;var d=this.oConfig.TILE_PROPERTIES.dimension;var c=this.oConfig.EVALUATION_VALUES;var f=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!f){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var o={};o["0"]=m+",asc";o["1"]=m+",desc";o["2"]=d+",asc";o["3"]=d+",desc";var g=o[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");var h=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oTileApi.url.addSystemToServiceUrl(u),a,m,d,v,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){h.uri+="&$top=3&$orderby="+g[0]+" "+g[2];}else{h.uri+="&$top=3&$orderby="+g[0]+" "+g[1];}this.comparisionChartODataRef=h.model.read(h.uri,null,null,true,function(c){var w={};if(h.unit[0]){t._updateTileModel({unit:c.results[0][h.unit[0].name]});b=h.unit[0].name;w.unit=h.unit[0];w.unit.name=h.unit[0].name;}if(c&&c.results&&c.results.length){d=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(t.oTileApi.url.addSystemToServiceUrl(u),a,d);w.dimension=d;t.oConfig.TILE_PROPERTIES.FINALVALUE=c;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,m.split(",")[0],d,b);if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id)){w=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);w.data=c;}else{w.data=c;}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,w);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(c.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=c;if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id)){w=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);w.data=c;}else{w.data=c;}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,w);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}else{t.setNoData();}},function(i){if(i&&i.response){jQuery.sap.log.error(i.message+" : "+i.request.requestUri);E.call(t,i);}});}else{if(f.unit){t._updateTileModel({unit:f.data.results[0][f.unit.name]});b=f.unit.name;}if(f.data&&f.data.results&&f.data.results.length){d=f.dimension;t.oConfig.TILE_PROPERTIES.FINALVALUE=f.data;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,m.split(",")[0],d,b);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(f.data.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=f.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}else{t.setNoData();}}}catch(e){E.call(t,e);}},_processDataForComparisonChart:function(d,m,a,u){var s=this.oConfig.TILE_PROPERTIES.semanticColorContribution;var f=[];var t;var b;for(var i=0;i<d.results.length;i++){var g=d.results[i];var h={};try{h.title=g[a].toString();}catch(e){h.title="";}h.value=Number(g[m]);var j=Number(g[m]);if(this.oConfig.EVALUATION.SCALING==-2){j*=100;}var c=this.isACurrencyMeasure(m);b=g[u];t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(j,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION,c,b);if(this.oConfig.EVALUATION.SCALING==-2){t+=" %";}h.displayValue=t.toString();if(typeof s==='undefined'){h.color="Neutral";}else{h.color=s;}f.push(h);}return f;},doDummyProcess:function(){var t=this;t.setTextInTile();t._updateTileModel({value:8888,size:sap.suite.ui.commons.InfoTileSize.Auto,frameType:sap.suite.ui.commons.FrameType.OneByOne,state:sap.suite.ui.commons.LoadState.Loading,valueColor:sap.suite.ui.commons.InfoTileValueColor.Error,indicator:sap.suite.ui.commons.DeviationIndicator.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral"},{title:"EMEA",value:50,color:"Neutral"},{title:"APAC",value:-20,color:"Neutral"}]});this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded);}});}());
