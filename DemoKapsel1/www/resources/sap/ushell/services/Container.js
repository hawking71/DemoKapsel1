// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.Container");jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ushell.System");var c,d="sap.ushell.Container.dirtyState.",p;sap.ushell.utils.testPublishAt(sap.ushell.services);function a(){close();}sap.ushell.utils.testPublishAt(sap.ushell.services);function r(){document.location="about:blank";}sap.ushell.utils.testPublishAt(sap.ushell.services);function g(){return localStorage;}function b(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function f(s){return(c.services&&c.services[s])||{};}function h(n,s,P){var A=f(n).adapter||{},e=A.module||b(s.getPlatform())+"."+n+"Adapter";jQuery.sap.require(e);return new(jQuery.sap.getObject(e))(s,P,{config:A.config||{}});}function j(c){var B=c.bootstrapPlugins,m;if(B){Object.keys(B).forEach(function(P){m=B[P].module;try{jQuery.sap.require(m);}catch(e){jQuery.sap.log.error(e,"Error when loading bootstrap plugin: "+P);}});}}function C(A){var l=new sap.ui.base.EventProvider(),k=false,R="sap.ushell.Container."+A.getSystem().getPlatform()+".remoteSystem.",m={},G,s,L=g(),S=new sap.ushell.utils.Map(),n="sap.ushell.Container."+A.getSystem().getPlatform()+".sessionTermination",t=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelLogon();}};this.createRenderer=function(e){var i,u,v,w;e=e||c.defaultRenderer;if(!e){throw new Error("Missing renderer name");}w=(c.renderers&&c.renderers[e])||{};u=w.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);jQuery.sap.require(u);if(w.componentData&&w.componentData.config){i={config:w.componentData.config};}v=new(jQuery.sap.getObject(u))({componentData:i});if(v instanceof sap.ui.core.UIComponent){v=new sap.ui.core.ComponentContainer({component:v,height:"100%",width:"100%"});}if(!(v instanceof sap.ui.core.Control)){throw new Error("Unsupported renderer type for name "+e);}return v;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,D=new jQuery.Deferred(),u=jQuery.sap.uid(),v,P=0,w=this.DirtyState.CLEAN;function x(){if(P===0||w===t.DirtyState.DIRTY){D.resolve(w);jQuery.sap.log.debug("getGlobalDirty() Resolving: "+w,null,"sap.ushell.Container");}}function y(z){if(z.key.indexOf(d)===0&&z.newValue!==t.DirtyState.INITIAL&&z.newValue!==t.DirtyState.PENDING){jQuery.sap.log.debug("getGlobalDirty() Receiving event key: "+z.key+" value: "+z.newValue,null,"sap.ushell.Container");if(z.newValue===t.DirtyState.DIRTY||z.newValue===t.DirtyState.MAYBE_DIRTY){w=z.newValue;}P-=1;x();}}try{L.setItem(u,"CHECK");L.removeItem(u);}catch(e){jQuery.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return D.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(G){throw new Error("getGlobalDirty already called!");}G=D;window.addEventListener('storage',y);D.always(function(){window.removeEventListener('storage',y);G=undefined;});for(i=L.length-1;i>=0;i-=1){v=L.key(i);if(v.indexOf(d)===0){if(L.getItem(v)==='PENDING'){L.removeItem(v);jQuery.sap.log.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+v,null,"sap.ushell.Container");}else{P+=1;sap.ushell.utils.localStorageSetItem(v,this.DirtyState.PENDING,true);jQuery.sap.log.debug("getGlobalDirty() Requesting status for: "+v,null,"sap.ushell.Container");}}}x();setTimeout(function(){if(D.state()!=="resolved"){D.resolve('MAYBE_DIRTY');jQuery.sap.log.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},P*2000);return D.promise();};this.getLogonSystem=function(){return A.getSystem();};this.getUser=function(){return A.getUser();};this.getDirtyFlag=function(){return k;};this.setDirtyFlag=function(i){k=i;};this.getService=function(e,P){var i={},M,K,u,v,w,x,y;function z(B){var D=new jQuery.Deferred();if(!B){throw new Error("Missing system");}D.resolve(h(e,B,P));sap.ushell.Container.addRemoteSystem(B);return D.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}x=f(e);M=x.module||"sap.ushell.services."+e;K=M+"/"+(P||"");y={config:x.config||{}};if(!S.containsKey(K)){jQuery.sap.require(M);u=jQuery.sap.getObject(M);if(u.hasNoAdapter===true){v=new u(i,P,y);}else{w=h(e,A.getSystem(),P);i.createAdapter=z;v=new u(w,i,P,y);}S.put(K,v);return v;}return S.get(K);};sap.ushell.utils.testPublishAt(t);function o(){var u,v,i,K;for(i=L.length-1;i>=0;i-=1){K=L.key(i);if(K.indexOf(R)===0){try{u=K.substring(R.length);v=JSON.parse(L.getItem(K));m[u]=new sap.ushell.System(v);}catch(e){L.removeItem(K);}}}return m;}sap.ushell.utils.testPublishAt(t,"suppressOData");function q(){function e(E,i,F){jQuery.sap.log.warning(E,null,"sap.ushell.Container");if(F){setTimeout(F.bind(null,E),5000);}return{abort:function(){return;}};}OData.read=function(i,u,F){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",u,F);};OData.request=function(i,u,F){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",u,F);};}this.addRemoteSystem=function(e){var i=e.getAlias(),O=m[i];if(O){if(O.toString()===e.toString()){return;}jQuery.sap.log.warning("Replacing "+O+" by "+e,null,"sap.ushell.Container");}else{jQuery.sap.log.debug("Added "+e,null,"sap.ushell.Container");}m[i]=e;sap.ushell.utils.localStorageSetItem(R+i,e);};this.addRemoteSystemForServiceUrl=function(e){var M,i={baseUrl:";o="};if(!e||e.charAt(0)!=='/'||e.indexOf('//')===0){return;}M=/^[^?]*;o=([^\/;?]*)/.exec(e);if(M&&M.length>=2){i.alias=M[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){i.platform="hana";i.alias=i.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){i.platform="abap";}if(i.alias&&i.platform){this.addRemoteSystem(new sap.ushell.System(i));}};this.attachLogoutEvent=function(F){l.attachEvent("Logout",F);};this.detachLogoutEvent=function(F,e){l.detachEvent("Logout",F);};this.logout=function(){var D=new jQuery.Deferred();function i(){A.logout(true).always(function(){L.removeItem(n);D.resolve();});}function u(){if(l.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}function v(){var m,w=[];if(s){window.removeEventListener('storage',s);}sap.ushell.utils.localStorageSetItem(n,"pending");q();m=o();Object.keys(m).forEach(function(x){try{w.push(h("Container",m[x]).logout(false));}catch(e){jQuery.sap.log.warning("Could not create adapter for "+x,e.toString(),"sap.ushell.Container");}L.removeItem(R+x);});jQuery.when.apply(jQuery,w).done(u);}if(typeof A.addFurtherRemoteSystems==='function'){A.addFurtherRemoteSystems().always(v);}else{v();}return D.promise();};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.setLogonFrameProvider(e);}};sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,E,D){t.addRemoteSystemForServiceUrl(D);});if(typeof A.logoutRedirect==='function'){s=function(e){function i(){a();r();}if(sap.ushell.Container!==t){return;}if(e.key.indexOf(R)===0&&e.newValue&&e.newValue!==L.getItem(e.key)){sap.ushell.utils.localStorageSetItem(e.key,e.newValue);}if(e.key===n){if(e.newValue==="pending"){q();if(l.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener('storage',s);}}sap.ushell.bootstrap=function(P,A){var o;if(sap.ushell.Container!==undefined){throw new Error("Cannot initialize twice");}sap.ushell.Container=null;c=JSON.parse(JSON.stringify(window["sap-ushell-config"]||{}));p=A;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}if(c.modulePaths){Object.keys(c.modulePaths).forEach(function(m){jQuery.sap.registerModulePath(m,c.modulePaths[m]);});}o=h("Container",new sap.ushell.System({alias:"",platform:c.platform||P}));return o.load().done(function(){sap.ushell.Container=new C(o);j(c);});};}());
