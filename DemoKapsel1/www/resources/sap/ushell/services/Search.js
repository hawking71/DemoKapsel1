// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.Search");jQuery.sap.require('sap.ushell.renderers.fiori2.search.SearchHelper');var s=sap.ushell.renderers.fiori2.search.SearchHelper;sap.ushell.services.Search=function(a,c){this.init.apply(this,arguments);};sap.ushell.services.Search.prototype={init:function(a,c){this.oAdapter=a;this.oContainerInterface=c;this.oLpdService=sap.ushell.Container.getService("LaunchPage");},isSearchAvailable:function(){return this.oAdapter.isSearchAvailable();},getSina:function(){return this.oAdapter.getSina();},_getCatalogTiles:function(){var c=this;if(c.allTilesDeferred){return c.allTilesDeferred;}var C=[];c.allTilesDeferred=c.oLpdService.getCatalogs().then(function(d){var D=[];var o=c._getPersonalizedGroupTiles(new jQuery.Deferred());D.push(o);for(var i=0;i<d.length;i++){D.push(c.oLpdService.getCatalogTiles(d[i]));}return jQuery.when.apply(jQuery,D).then(function(){var t=arguments;for(var i=0;i<t.length;i++){var T=t[i];for(var j=0;j<T.length;j++){try{var f=T[j],g=c.oLpdService.getCatalogTileView(f),k=c.oLpdService.getCatalogTileKeywords(f),h=c.oLpdService.getCatalogTileTargetURL(f),l=c.oLpdService.getCatalogTilePreviewTitle(f)||c.oLpdService.getCatalogTileTitle(f),S=c.oLpdService.getCatalogTileSize(f),I=c.oLpdService.getCatalogTilePreviewIcon(f)||"sap-icon://business-objects-experience";C.push({tile:f,keywords:k,url:h,title:l||'',icon:I,size:S});g.destroy();}catch(e){jQuery.sap.log.error(e);}}}C=c._removeDuplicateTiles(C);C.sort(function(a,b){if(a.title.toUpperCase()<b.title.toUpperCase()){return-1;}if(a.title.toUpperCase()>b.title.toUpperCase()){return 1;}return 0;});return C;});});return c.allTilesDeferred;},_getPersonalizedGroupTiles:function(d){var a=this;a.oLpdService.getGroups().then(function(g){var D=[];var G;for(var j=0;j<g.length;j++){G=a.oLpdService.getGroupTiles(g[j])||[];D=D.concat(G);}d.resolve(D);});return d.promise();},_removeDuplicateTiles:function(t){var I={},k,u=[];for(var i=0;i<t.length;++i){var T=t[i];if(!T.url){continue;}var f=new RegExp('DisplayFactSheet','i');if(f.test(T.url)){continue;}k=T.title+T.url;if(I[k]===undefined){I[k]=T;u.push(T);}}return u;},_searchTiles:function(p){var S=p.searchTerm;var c=p.aCatalogTiles;var t=p.top||10;var i=p.skip||0;var m=0;var b=p.searchInKeywords||false;var f=[],T;var a=function(T,h){m+=1;if(m<=i){return;}if(m>(i+t)){return;}var r=jQuery.extend({},T);r.tooltip=r.title;if(h.length>0){r.label=h;r.title=h;}else{r.label=T.title;}f.push(r);};var o=new s.Tester(S);var d,C;for(var j=0;j<c.length;j++){T=c[j];d=o.test(T.title);if(d.bMatch===true){a(T,d.sHighlightedText);continue;}if(b&&T.keywords&&Array.isArray(T.keywords)){d=o.test(T.keywords.join(' '));if(d.bMatch===true){a(T,"");}}}return{totalResults:m,searchTerm:S,getElements:function(){return f;}};},queryApplications:function(p){var a=this,o=p.searchTerm;return this._getCatalogTiles().then(function(c){p.aCatalogTiles=c;return a._searchTiles(p);});},queryApplicationsByTarget:function(S,r){this._getCatalogTiles().done(function(c){var R=[];for(var j=0,l=S&&S.length||0;j<l;j++){var o=S[j],u=sap.ushell.Container.getService("URLParsing");for(var i=0;i<c.length;i++){var t=u.parseShellHash(c[i].url);if(t&&(t.semanticObject===o.semanticObject)&&(t.action===o.action)){R.push(c[i]);break;}}}r(R);});}};}());
