// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ui.thirdparty.signals");jQuery.sap.require("sap.ui.thirdparty.hasher");jQuery.sap.require("sap.ui.core.routing.HashChanger");jQuery.sap.declare("sap.ushell.services.ShellNavigation");sap.ui.core.routing.HashChanger.extend("sap.ushell.services.ShellNavigationHashChanger",{constructor:function(c){var u;this.oServiceConfig=c;if(jQuery.sap.getUriParameters().get("sap-ushell-reload")){if(jQuery.sap.getUriParameters().get("sap-ushell-reload")==="X"||jQuery.sap.getUriParameters().get("sap-ushell-reload")==="true"){u=true;}else{u=false;}}if(u!==undefined){if(typeof this.oServiceConfig!=="object"){this.oServiceConfig={};}this.oServiceConfig.reload=u;}sap.ui.core.routing.HashChanger.apply(this);this.priv_initializedByShellNav=false;this.oURLShortening=sap.ushell.Container.getService("URLShortening");this.privfnShellCallback=null;this.privappHashPrefix="&/";this.privhashPrefix="#";this.aNavigationFilters=[];this.NavigationFilterStatus={Continue:"Continue",Custom:"Custom",Abandon:"Abandon"};this.privgetCurrentShellHash=function(){var r=this.privsplitHash(hasher.getHash());return{hash:"#"+((r&&r.shellPart)?r.shellPart:"")};};this.privconstructHash=function(A){var o=this.privgetCurrentShellHash();o.hash=o.hash+A;return o;};this.privconstructShellHash=function(s){return sap.ushell.Container.getService("URLParsing").constructShellHash(s);};this.privsplitHash=function(h){var s,A;if(h===undefined||h===null||h===""){return{shellPart:null,appSpecificRoute:null};}s=sap.ushell.Container.getService("URLParsing").parseShellHash(h);if(s===undefined||s===null){return null;}A=s.appSpecificRoute;s.appSpecificRoute=undefined;return{shellPart:(s&&this.privstripLeadingHash(this.privconstructShellHash(s)))||null,appSpecificRoute:(s&&A)||null};};this.privsetHash=function(f,A,w){hasher.prependHash="";f=this.privstripLeadingHash(f);A=A||"";if(w===undefined){w=true;}if(w){this.fireEvent("hashSet",{sHash:A});hasher.setHash(f);}else{this.fireEvent("hashReplaced",{sHash:A});hasher.replaceHash(f);}};this.privstripLeadingHash=function(h){if(h[0]==='#'){return h.substring(1);}return h;};this.registerNavigationFilter=function(f){if(typeof f!=="function"){throw new Error("fnFilter must be a function");}this.aNavigationFilters.push(f);};function a(C){this.oAppState=undefined;this.oPromise=(new jQuery.Deferred()).resolve();this.getNextKey=function(){this.oAppState=sap.ushell.Container.getService("AppState").createEmptyAppState(C);return this.oAppState.getKey();};this.store=function(v){var n;this.oAppState.setData(v);n=this.oAppState.save();this.oPromise=jQuery.when(this.oPromise,n);};this.getPromise=function(){return this.oPromise;};}this.hrefForExternal=function(A,v,C,b){var t,p,d,s=new a(C),r;t=this.privhrefForExternalNoEnc(A,s);if(v===true){r={hash:encodeURI(t.hash),params:t.params,skippedParams:t.skippedParams};}else{r=encodeURI(t.hash);}if(!b){return r;}p=s.getPromise();d=new jQuery.Deferred();p.done(function(){d.resolve(r);}).fail(function(m){d.reject(m);});return d;};this.privhrefForExternalNoEnc=function(A,s){var r;if(A===undefined){return this.privgetCurrentShellHash();}if(A&&A.target&&(typeof A.target.semanticObject==="string"||typeof A.target.shellHash==="string")){r="#"+this.privconstructShellHash(A);return this.oURLShortening.compactHash(r,undefined,s);}return this.privgetCurrentShellHash();};this.privgetAppHash=function(A){var s,o;if(A&&A.target&&(typeof A.target.shellHash==="string")){o=sap.ushell.Container.getService("URLParsing").parseShellHash(A.target.shellHash);s=o&&o.appSpecificRoute;s=s&&s.substring(2);}return s;};this.hrefForAppSpecificHash=function(A){return encodeURI(this.privconstructHash(this.privappHashPrefix+A).hash);};this.toExternal=function(A,C){var h,s=new a(C),b;h=this.privhrefForExternalNoEnc(A,s).hash;b=this.privgetAppHash(A);this.privsetHash(h,b);};this.toAppHash=function(A,w){var h=this.privconstructHash(this.privappHashPrefix+A).hash;this.privsetHash(h,A,w);};}});sap.ushell.services.ShellNavigationHashChanger.prototype.initShellNavigation=function(s){if(this.priv_initializedByShellNav){jQuery.sap.log.info("initShellNavigation already called on this ShellNavigationHashChanger instance.");return false;}this.privfnShellCallback=s;hasher.changed.add(this.treatHashChanged,this);if(!hasher.isActive()){hasher.initialized.addOnce(this.treatHashChanged,this);hasher.init();}else{this.treatHashChanged(hasher.getHash());}this.priv_initializedByShellNav=true;return true;};sap.ushell.services.ShellNavigationHashChanger.prototype.init=function(){if(this.priv_initialized){jQuery.sap.log.info("init already called on this ShellNavigationHashChanger instance.");return false;}var n=this.privsplitHash(hasher.getHash()),a=n&&(n.appSpecificRoute||"  ").substring(2);this.fireEvent("hashChanged",{newHash:a});this.priv_initialized=true;return true;};sap.ushell.services.ShellNavigationHashChanger.prototype.treatHashChanged=function(n,o){if(this.inAbandonFlow){return;}var a,O,N,b,E,i,f;n=this.oURLShortening.expandHash(n);o=this.oURLShortening.expandHash(o);N=this.privsplitHash(n);b=this.privsplitHash(o);if(!N){E=new Error("Illegal new hash - cannot be parsed: '"+n+"'");this.fireEvent("shellHashChanged",{newShellHash:n,newAppSpecificRoute:null,oldShellHash:(b?b.shellPart:o),error:E});this.privfnShellCallback(n,null,(b?b.shellPart:o),(b?b.appSpecificRoute:null),E);return;}if(!b){b={shellPart:o,appSpecificRoute:null};}for(i=0;i<this.aNavigationFilters.length;i=i+1){try{f=this.aNavigationFilters[i].call(undefined,n,o);if(f===this.NavigationFilterStatus.Custom){return;}if(f===this.NavigationFilterStatus.Abandon){this.inAbandonFlow=true;hasher.replaceHash(o);this.inAbandonFlow=false;return;}}catch(e){jQuery.sap.log.error("Error while calling Navigation filter! ignoring filter...",e.message,"sap.ushell.services.ShellNavigation");}}if(N.shellPart===b.shellPart&&(o!==undefined)){a=(N.appSpecificRoute||"  ").substring(2);O=(b.appSpecificRoute||"  ").substring(2);this.fireEvent("hashChanged",{newHash:a,oldHash:O});return;}function r(h){window.location.hash='#'+encodeURI(h);window.location.reload();}if(o!==undefined){if(this.oServiceConfig&&this.oServiceConfig.reload){r(n);}}this.fireEvent("shellHashChanged",{newShellHash:N.shellPart,newAppSpecificRoute:N.appSpecificRoute,oldShellHash:b.shellPart,oldAppSpecificRoute:b.appSpecificRoute});this.privfnShellCallback(N.shellPart,N.appSpecificRoute,b.shellPart,b.appSpecificRoute);};sap.ushell.services.ShellNavigationHashChanger.prototype.setHash=function(h){this.toAppHash(h,true);};sap.ushell.services.ShellNavigationHashChanger.prototype.replaceHash=function(h){this.toAppHash(h,false);};sap.ushell.services.ShellNavigationHashChanger.prototype.getHash=function(){return this.getAppHash();};sap.ushell.services.ShellNavigationHashChanger.prototype.getAppHash=function(){var n=this.privsplitHash(hasher.getHash()),a=n&&(n.appSpecificRoute||"  ").substring(2);return a;};sap.ushell.services.ShellNavigationHashChanger.prototype.destroy=function(){hasher.changed.remove(this.treatHashChanged,this);sap.ui.core.routing.HashChanger.prototype.destroy.apply(this,arguments);};function S(c,p,s){var o=s&&s.config;this.hashChanger=new sap.ushell.services.ShellNavigationHashChanger(o);this.hrefForExternal=function(a,v,C,A){return this.hashChanger.hrefForExternal(a,v,C,A);};this.hrefForAppSpecificHash=function(a){return this.hashChanger.hrefForAppSpecificHash(a);};this.toExternal=function(a,C){this.hashChanger.toExternal(a,C);};this.toAppHash=function(a,w){this.hashChanger.toAppHash(a,w);};this.init=function(f){hasher.prependHash="";sap.ui.core.routing.HashChanger.replaceHashChanger(this.hashChanger);this.hashChanger.initShellNavigation(f);return this;};this.NavigationFilterStatus=this.hashChanger.NavigationFilterStatus;this.registerNavigationFilter=function(f){this.hashChanger.registerNavigationFilter(f);};}sap.ushell.services.ShellNavigation=S;sap.ushell.services.ShellNavigation.hasNoAdapter=true;}());
