// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.UserRecents");jQuery.sap.require("sap.ushell.services.Personalization");function R(m,E,c,l,s){var r=[],u=function(I,t){return r.some(function(o){var f;if(E(o.oItem,I)){o.oItem=I;o.iTimestamp=t;o.iCount=o.iCount+1;f=true;}else{f=false;}return f;});},i=function(I,t){var n={oItem:I,iTimestamp:t,iCount:1};if(r.length===m){r.sort(c);r.pop();}r.push(n);};this.newItem=function(I){var t=+new Date(),A;l().done(function(L){r=L||[];A=u(I,t);if(!A){i(I,t);}s(r);});};this.getRecentItems=function(){var d=new jQuery.Deferred();l().done(function(L){L=L||[];L.sort(c);r=L.slice(0,m);d.resolve(jQuery.map(r,function(o){return o.oItem;}));});return d.promise();};};function a(l,s){var A,t=this,m=30,d=false,n=[];this.init=function(){var t=this,p,c=this.getDayFromDateObj(this.getCurrentDate()),D=false;if(t._oInitDeferred===undefined){t._oInitDeferred=jQuery.Deferred();}if(!D||c!==A.recentDay){D=true;p=l();p.done(function(b){A=b||{recentDay:null,recentAppsUsageMap:{}};t.calculateInitialUsage(c);t._oInitDeferred.resolve(A);});p.fail(function(){jQuery.sap.log.error("UShell-lib ; RecentAppsUsage ; Load data in Init failed");t._oInitDeferred.reject();});}return this._oInitDeferred.promise();};this.calculateInitialUsage=function(c){var t=this;if(c!=A.recentDay){this.addNewDay();A.recentDay=c;setTimeout(function(){t.cleanUnusedHashes();},3000);this.saveAppsUsage(A);}};this.addAppUsage=function(h){if(!sap.ushell.utils.validHash(h)){return jQuery.Deferred().reject("Non valid hash").promise();}var p=this.init();p.done(function(){var b=A.recentAppsUsageMap[h]||[];if(b.length==0){b[0]=1;}else{b[b.length-1]+=1;}A.recentAppsUsageMap[h]=b;t.saveAppsUsage(A);});p.fail(function(){Query.sap.log.error("Ushell-lib ; addAppUsage ; Initialization falied!");});return p;};this.getAppsUsage=function(){var r,p,t=this,D=jQuery.Deferred();p=t.init();p.done(function(){r=t.summarizeUsage();D.resolve(r);});p.fail(function(){D.reject("Not initialized yet");});return D.promise();};this.summarizeUsage=function(){var u={},h,b,c,f=true;for(h in A.recentAppsUsageMap){u[h]=this.getHashUsageSum(h);if(f){b=c=u[h];f=false;}else{if(u[h]<c){c=u[h];}else if(u[h]>b){b=u[h];}}}return{usageMap:u,maxUsage:b,minUsage:c};};this.addNewDay=function(){var h,b;for(h in A.recentAppsUsageMap){b=A.recentAppsUsageMap[h];b[b.length]=0;if(b.length>m){b=b.shift();}}};this.cleanUnusedHashes=function(){var u,h;for(h in A.recentAppsUsageMap){u=t.getHashUsageSum(h);if(u==0){delete(A.recentAppsUsageMap[h]);}}};this.getHashUsageSum=function(h){var b=0,c,f=A.recentAppsUsageMap[h],g=f.length;for(c=0;c<g;c++){b+=f[c];}return b;};this.saveAppsUsage=function(o){var p=s(o);p.fail(function(){jQuery.sap.log.error("Ushell-lib ; saveAppsUsage ; Save action failed");});p.done(function(b){});return p;};this.getCurrentDate=function(){return new Date();};this.getDayFromDateObj=function(b){return(b.getUTCFullYear()+"/"+(b.getUTCMonth()+1)+"/"+b.getUTCDate());};};sap.ushell.services.UserRecents=function(){var r,o,A,b,p,c,s,d,f,l,S,g="RecentApps",h="AppsUsage",i="RecentSearches",j="RecentDataSources",P="sap.ushell.services.UserRecents";this.noticeDataSource=function(D){if((D&&D.objectName&&D.objectName.value&&D.objectName.value.toLowerCase()==="$$all$$")||(D.objectName&&D.objectName.toLowerCase&&D.objectName.toLowerCase()==="$$all$$"))return;b.newItem(D);return b.getRecentItems();};this.getRecentDataSources=function(){return b.getRecentItems();};this.noticeSearch=function(m){r.newItem(m);return r.getRecentItems();};this.getRecentSearches=function(){return r.getRecentItems();};this.noticeApp=function(m){o.newItem(m);return o.getRecentItems();};this.getRecentApps=function(){return o.getRecentItems();};this.initAppsUsage=function(){A.init(new Date());};this.addAppUsage=function(m){var n=sap.ushell.utils.getBasicHash(m);A.addAppUsage(n);};this.getAppsUsage=function(){return A.getAppsUsage();};p=sap.ushell.Container.getService("Personalization");try{c=p.getPersonalizer({container:P,item:g});s=p.getPersonalizer({container:P,item:i});d=p.getPersonalizer({container:P,item:j});f=p.getPersonalizer({container:P,item:h});}catch(k){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(k.name+": "+k.message);}l=function(m){var n,D;try{n=m.getPersData();}catch(k){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(k.name+": "+k.message);D=new jQuery.Deferred();D.reject(k);n=D.promise();}return n;};S=function(m,L){var n;try{n=m.setPersData(L);}catch(k){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(k.name+": "+k.message);}return n;};r=new R(10,function(x,y){var m=false;if(x.oDataSource&&y.oDataSource){if(x.oDataSource.objectName&&y.oDataSource.objectName){m=((x.sTerm===y.sTerm)&&(x.oDataSource.objectName.value===y.oDataSource.objectName.value));}if(!x.oDataSource.objectName&&!y.oDataSource.objectName){m=(x.sTerm===y.sTerm);}}if(!x.oDataSource&&!y.oDataSource){m=(x.sTerm===y.sTerm);}return m;},function(x,y){return y.iTimestamp-x.iTimestamp;},l.bind(this,s),S.bind(this,s));b=new R(6,function(x,y){if(x.objectName&&y.objectName)return x.objectName.value===y.objectName.value;return false;},function(x,y){return y.iTimestamp-x.iTimestamp;},l.bind(this,d),S.bind(this,d));o=new R(6,function(x,y){return x.semanticObject===y.semanticObject&&x.action===y.action;},function(x,y){return y.iTimestamp-x.iTimestamp;},l.bind(this,c),S.bind(this,c));A=new a(l.bind(this,f),S.bind(this,f));};var e=sap.ui.getCore().getEventBus();sap.ushell.services.UserRecents.hasNoAdapter=true;}());
