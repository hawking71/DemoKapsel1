// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.utils");sap.ushell.utils={};var v;sap.ushell.utils.Error=function(m,c){this.name="sap.ushell.utils.Error";this.message=m;jQuery.sap.log.error(m,null,c);};sap.ushell.utils.Error.prototype=new Error();sap.ushell.utils.localStorageSetItem=function(k,V,l){var E;try{localStorage.setItem(k,V);if(l){E=document.createEvent("StorageEvent");E.initStorageEvent("storage",false,false,k,"",V,"",localStorage);dispatchEvent(E);}}catch(e){jQuery.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.utils");}};sap.ushell.utils.calculateOrigin=function(d){var u;if(d.origin){return d.origin;}if(d.protocol&&d.hostname){return d.protocol+"//"+d.hostname+(d.port?':'+d.port:'');}if(d.href){u=new URI(d.href);return u.protocol()+"://"+u.hostname()+(u.port()?':'+u.port():'');}};sap.ushell.utils.Map=function(){this.entries={};};sap.ushell.utils.Map.prototype.put=function(k,V){var o=this.get(k);this.entries[k]=V;return o;};sap.ushell.utils.Map.prototype.containsKey=function(k){if(typeof k!=="string"){throw new sap.ushell.utils.Error("Not a string key: "+k,"sap.ushell.utils.Map");}return Object.prototype.hasOwnProperty.call(this.entries,k);};sap.ushell.utils.Map.prototype.get=function(k){if(this.containsKey(k)){return this.entries[k];}};sap.ushell.utils.Map.prototype.keys=function(){return Object.keys(this.entries);};sap.ushell.utils.Map.prototype.remove=function(k){delete this.entries[k];};sap.ushell.utils.Map.prototype.toString=function(){var r=['sap.ushell.utils.Map('];r.push(JSON.stringify(this.entries));r.push(')');return r.join('');};sap.ushell.utils.getParameterValueBoolean=function(p,P){var a=jQuery.sap.getUriParameters(P).mParams&&jQuery.sap.getUriParameters(P).mParams[p],t=["true","x"],f=["false",""],V;if(!a||a.length===0){return undefined;}V=a[0].toLowerCase();if(t.indexOf(V)>=0){return true;}if(f.indexOf(V)>=0){return false;}return undefined;};sap.ushell.utils.testPublishAt=function(o,e){};sap.ushell.utils.call=function(s,f,a){var m;if(a){setTimeout(function(){sap.ushell.utils.call(s,f,false);},0);return;}try{s();}catch(e){m=e.message||e.toString();jQuery.sap.log.error("Call to success handler failed: "+m,e.stack,"sap.ushell.utils");if(f){f(m);}}};sap.ushell.utils.handleTilesVisibility=function(){clearTimeout(v);v=setTimeout(function(){var s=new Date(),t=sap.ushell.utils.getVisibleTiles(),d,l;if(t&&t.length){l=sap.ushell.Container.getService("LaunchPage");t.forEach(function(T){var a=sap.ushell.utils.getTileObject(T);if(a!==null){l.setTileVisible(a,T.isDisplayedInViewPort);}});jQuery.sap.log.debug("Visible Tiles: "+t.filter(function(T){return T.isDisplayedInViewPort;}).length);jQuery.sap.log.debug("NonVisible Tiles: "+t.filter(function(T){return!T.isDisplayedInViewPort;}).length);}d=new Date()-s;jQuery.sap.log.debug("Start time is: "+s+" and duration is: "+d);},1000);};sap.ushell.utils.setTilesNoVisibility=function(){var t=sap.ushell.utils.getVisibleTiles(),l;if((typeof t!=="undefined")&&t.length>0){l=sap.ushell.Container.getService("LaunchPage");t.forEach(function(T){l.setTileVisible(sap.ushell.utils.getTileObject(T),false);});jQuery.sap.log.debug("Visible Tiles: "+t.filter(function(T){return T.isDisplayedInViewPort;}).length);jQuery.sap.log.debug("NonVisible Tiles: "+t.filter(function(T){return!T.isDisplayedInViewPort;}).length);}};sap.ushell.utils.getBasicHash=function(h){if(!sap.ushell.utils.validHash(h)){jQuery.sap.log.debug("Utils ; getBasicHash ; Got invalid hash");return false;}var u=sap.ushell.Container.getService("URLParsing"),s=u.parseShellHash(h);return s?s.semanticObject+"-"+s.action:h;};sap.ushell.utils.validHash=function(h){return(h&&h.constructor===String&&jQuery.trim(h)!="");};sap.ushell.utils.handleTilesOpacity=function(){jQuery.sap.require("sap.ui.core.theming.Parameters");var t,c,a,C=sap.ui.core.theming.Parameters.get("sapUshellTileBackgroundColor"),r=this.hexToRgb(C),j,b,R,d,s,e,o,p,g,f,h=sap.ui.getCore(),m=h.byId("shell").getModel(),u=sap.ushell.Container.getService("UserRecents");if(r){R="rgba("+r.r+","+r.g+","+r.b+",{0})";a=u.getAppsUsage();a.done(function(i){t=i.usageMap;j=jQuery('.sapUshellTile').not('.sapUshellTileFooter');var k=m.getProperty("/groups");m.setProperty('/animationRendered',true);for(var l=0;l<j.length;l++){d=jQuery(j[l]);s=this.getBasicHash(d.find('.sapUshellTileBase').attr('data-targeturl'));if(s){b=this.convertToRealOpacity(t[s],i.maxUsage);e=R.replace("{0}",b);c=sap.ui.getCore().byId(d.attr('id'));o=c.getBindingContext();p=o.sPath.split('/');g=p[2];f=p[4];k[g].tiles[f].rgba=e;}}m.setProperty("/groups",k);}.bind(this));}};sap.ushell.utils.convertToRealOpacity=function(a,m){var o=[1,0.95,0.9,0.85,0.8],O=Math.floor(m/o.length),i;if(!a){return o[0];}else if(!m){return o[o.length-1];}else{i=Math.floor((m-a)/O);return i<o.length?o[i]:o[o.length-1];}};sap.ushell.utils.getCurrentHiddenGroupIds=function(){var g=sap.ui.getCore().byId("shell").getModel().getProperty('/groups'),h=[],G,a;for(a in g){if(!g[a].isGroupVisible){G=g[a].groupId;h.push(G);}}return h;};sap.ushell.utils.hexToRgb=function(h){var i=!h||h[0]!='#'||(h.length!=4&&h.length!=7),r;h=!i&&h.length===4?'#'+h[1]+h[1]+h[2]+h[2]+h[3]+h[3]:h;r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null;};sap.ushell.utils.getFormFactor=function(){var s=sap.ui.Device.system;if(s.desktop){return s.SYSTEMTYPE.DESKTOP;}else if(s.tablet){return s.SYSTEMTYPE.TABLET;}else{return s.phone?s.SYSTEMTYPE.PHONE:undefined;}};sap.ushell.utils.getVisibleTiles=function(){var n=document.body.clientHeight,c=sap.ui.getCore().byId("dashboardGroups"),N=sap.ui.getCore().byId("navContainer"),g,t,a,b,T,d,e,f,h,s=jQuery('#shell-hdr').height(),i=[];if(c&&c.getGroups()&&N){var C=N.getModel().getProperty("/currentState/stateName"),I=C==="home",G=c.getGroups();for(g=0;g<G.length;g=g+1){a=G[g];b=a.getTiles();if(b){for(t=0;t<b.length;t=t+1){T=b[t];if(!I){T.isDisplayedInViewPort=false;}else{d=jQuery(T.getDomRef());e=d.offset();if(!e){return null;}f=d.offset().top;h=f+d.height();T.isDisplayedInViewPort=(h>s)&&(f<n);}i.push(T);}}}}return i;};sap.ushell.utils.getTileObject=function(u){var b=u.getBindingContext();return b.getObject()?b.getObject().object:null;};sap.ushell.utils.addBottomSpace=function(){var j=jQuery('#dashboardGroups').find('.sapUshellTileContainer:visible'),l=j.last(),h=jQuery(".sapUshellShellHead").height(),a=l.parent().height(),g=parseInt(l.find(".sapUshellContainerTitle").css("margin-top"),10),b=parseInt(jQuery('.sapUshellDashboardGroupsContainer').css("padding-bottom"),10);var n=jQuery(window).height()-h-a-g-b;n=(n<0)?0:n;jQuery('.sapUshellDashboardGroupsContainer').css("margin-bottom",n+"px");};sap.ushell.utils.groupHasVisibleTiles=function(g){var a=false,t,b;if(!g||(g&&g.length===0)){return false;}for(t=0;t<g.length;t=t+1){b=g[t];if(b.isTileIntentSupported){a=true;break;}}return a;};}());
